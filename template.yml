AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: SAM template for lambda function

Parameters:
  ToolImageUri:
    Type: String
    Description: ECR image URI for the MCP tool target lambda function - used by AgentCore gateway deployment

  AgentImageUri:
    Type: String
    Description: ECR image URI for the agent - used by AgentCore runtime deployment

  AppImageUri:
    Type: String
    Description: ECR image URI for the app - used by ECS deployment

  OverpassApiUrl:
    Type: String
    Description: Overpass API URL for terrain data queries
  
  NrelApiBaseUri:
    Type: String
    Description: Base URL for NREL API
    Default: "http://developer.nrel.gov/api/wind-toolkit/v2/wind/wtk-bchrrr-v1-0-0-download.csv"
  
  NrelApiKey:
    Type: String
    Description: NREL API key
    Default: "DEMO_KEY"
  
  NrelApiEmail:
    Type: String
    Description: NREL API email
    Default: "nrg-workshops@amazon.com"

Resources:
  WindFarmToolLambda:
    Type: AWS::Serverless::Function
    Properties:
      ImageUri: !Ref ToolImageUri
      PackageType: Image
      Timeout: 300
      MemorySize: 2048
      Architectures:
        - arm64
      Environment:
        Variables:
          NREL_API_BASE_URI: !Ref NrelApiBaseUri
          NREL_API_KEY: !Ref NrelApiKey
          NREL_API_EMAIL: !Ref NrelApiEmail
      Policies:
        - AWSLambdaBasicExecutionRole

  GatewayRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          Effect: Allow
          Principal:
            Service: bedrock-agentcore.amazonaws.com
          Action: sts:AssumeRole
      Policies:
        - PolicyName: AgentCoreGatewayExecutionPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action: lambda:InvokeFunction
                Resource: !GetAtt WindFarmToolLambda.Arn
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:*"
              - Effect: Allow
                Action:
                  - bedrock-agentcore:GetWorkloadAccessToken
                Resource:
                  - !Sub "arn:aws:bedrock-agentcore:${AWS::Region}:${AWS::AccountId}:workload-identity-directory/default"
                  - !Sub "arn:aws:bedrock-agentcore:${AWS::Region}:${AWS::AccountId}:workload-identity-directory/default/workload-identity/*"
  WindAgentCoreGateway:
    Type: AWS::BedrockAgentCore::Gateway
    Properties:
      AuthorizerType: AWS_IAM
      Description: AgentCore Gateway with AWS Lambda target type
      ExceptionLevel: DEBUG
      Name: wind-farm-mcp-tools
      ProtocolType: MCP
      RoleArn: !GetAtt GatewayRole.Arn

  WindAgentCoreGatewayLambdaTarget:
    Type: AWS::BedrockAgentCore::GatewayTarget
    Properties:
      CredentialProviderConfigurations:
        - CredentialProviderType: GATEWAY_IAM_ROLE
      Description: Wind Development Tools Lambda Target
      GatewayIdentifier: !GetAtt WindAgentCoreGateway.GatewayIdentifier
      Name: wind-farm-tools-lambda
      TargetConfiguration:
        Mcp:
          Lambda:
            LambdaArn: !GetAtt WindFarmToolLambda.Arn
            ToolSchema:
              InlinePayload:
                - Name: "get_wind_conditions"
                  Description: "Fetches wind data from NREL API for a specific location and year. Returns: Dictionary with the wind conditions for the location."
                  InputSchema:
                    Type: "object"
                    Properties:
                      latitude:
                        Type: "number"
                        Description: "Latitude coordinate of the location."
                      longitude:
                        Type: "number"
                        Description: "Longitude coordinate of the location."
                      year:
                        Type: "number"
                        Description: "Year for wind data (default: 2023)."
                    Required:
                      - "latitude"
                      - "longitude"

  RuntimeRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          Effect: Allow
          Principal:
            Service: bedrock-agentcore.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
      Policies:
        - PolicyName: AgentCoreRuntimePolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                  - bedrock:Retrieve
                Resource: 
                  - !Sub "arn:aws:bedrock:*::foundation-model/*"
                  - !Sub "arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:*"
              - Effect: Allow
                Action:
                  - aws-marketplace:Subscribe
                  - aws-marketplace:ViewSubscriptions
                  - aws-marketplace:Unsubscribe
                Resource: "*"
              - Effect: Allow
                Action:
                  - ecr:BatchGetImage
                  - ecr:GetDownloadUrlForLayer
                  - ecr:GetAuthorizationToken
                  - ecr:BatchGetImage
                  - ecr:GetDownloadUrlForLayer
                Resource: !Sub "arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/*"
              - Effect: Allow
                Action:
                  - logs:DescribeLogStreams
                  - logs:CreateLogGroup
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:*"
              - Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                Resource: "*"
              - Effect: Allow
                Action:
                  - xray:PutTraceSegments
                  - xray:PutTelemetryRecords
                  - xray:GetSamplingRules
                  - xray:GetSamplingTargets
                Resource: "*"
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                  - secretsmanager:UpdateSecret
                  - secretsmanager:CreateSecret
                Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:*"
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: "*"
                Condition:
                  StringEquals:
                    "cloudwatch:namespace": "bedrock-agentcore"
              - Effect: Allow
                Action:
                  - bedrock-agentcore:InvokeGateway
                Resource:
                  - !Sub "arn:aws:bedrock-agentcore:${AWS::Region}:${AWS::AccountId}:gateway/*"
              - Effect: Allow
                Action:
                  - bedrock-agentcore:GetWorkloadAccessToken
                  - bedrock-agentcore:GetWorkloadAccessTokenForJWT
                  - bedrock-agentcore:GetWorkloadAccessTokenForUserId
                Resource:
                  - !Sub "arn:aws:bedrock-agentcore:${AWS::Region}:${AWS::AccountId}:workload-identity-directory/default"
                  - !Sub "arn:aws:bedrock-agentcore:${AWS::Region}:${AWS::AccountId}:workload-identity-directory/default/workload-identity/*"
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                  - ssm:GetParametersByPath
                Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*"

  Runtime:
    Type: AWS::BedrockAgentCore::Runtime
    Properties:
      AgentRuntimeName: wind_dev_agent
      AgentRuntimeArtifact:
        ContainerConfiguration:
          ContainerUri: !Ref AgentImageUri
      EnvironmentVariables:
        DISABLE_CALLBACK_HANDLER: "1"
        AWS_REGION: !Ref AWS::Region
        AWS_DEFAULT_REGION: !Ref AWS::Region
        OVERPASS_API_URL: !Ref OverpassApiUrl
      NetworkConfiguration:
        NetworkMode: PUBLIC
      RoleArn: !GetAtt RuntimeRole.Arn

  SSMParameterAgentRuntimeARN:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Name: /wind-farm-assistant/agentcore-runtime-arn
      Value: !GetAtt Runtime.AgentRuntimeArn

  SSMParameterGatewayUrl:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Name: /wind-farm-assistant/gateway_url
      Value: !GetAtt WindAgentCoreGateway.GatewayUrl

  SSMParameterAgentStorageUseS3:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Name: /wind-farm-assistant/use-s3-storage
      Value: "true"

  SSMParameterAgentStorageBucketName:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Name: /wind-farm-assistant/s3-bucket-name
      Value: !Ref WindAgentsStorageBucket

  WindAgentsStorageBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "wind-dev-agent-${AWS::AccountId}-storage"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete

  WebApplicationAccessRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          Effect: Allow
          Principal:
            Service: build.apprunner.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSAppRunnerServicePolicyForECRAccess

  WebApplicationInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: tasks.apprunner.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: WebApplicationPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - bedrock-agentcore:*
                Resource: 
                - !Sub "arn:aws:bedrock-agentcore:${AWS::Region}:${AWS::AccountId}:*"
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:HeadObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Sub "arn:aws:s3:::wind-dev-agent-${AWS::AccountId}-storage/*"
                  - !Sub "arn:aws:s3:::wind-dev-agent-${AWS::AccountId}-storage"
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                  - ssm:GetParametersByPath
                Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/wind-farm-assistant/*"
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
              - Effect: Allow
                Action:
                  - aws-marketplace:Subscribe
                  - aws-marketplace:Unsubscribe
                  - aws-marketplace:ViewSubscriptions
                Resource: "*"  

  WebApplicationWebACL:
    Type: "AWS::WAFv2::WebACL"
    Properties:
      Name: WindFarmAppWebAcl
      Scope: REGIONAL
      DefaultAction:
        Allow: {}
      VisibilityConfig:
        SampledRequestsEnabled: True
        CloudWatchMetricsEnabled: True
        MetricName: WindFarmAppAclMetric
      Rules:
        - Name: RateLimitRule
          Action:
            Block: {}
          Priority: 1
          Statement:
            RateBasedStatement:
              Limit: 200
              AggregateKeyType: IP
              EvaluationWindowSec: 60
          VisibilityConfig:
            SampledRequestsEnabled: True
            CloudWatchMetricsEnabled: True
            MetricName: WindFarmAppRateLimitMetric

  WebApplication:
    Type: AWS::AppRunner::Service
    Properties:
      ServiceName: wind-farm-app
      SourceConfiguration:
        AuthenticationConfiguration:
          AccessRoleArn: !GetAtt WebApplicationAccessRole.Arn
        AutoDeploymentsEnabled: true
        ImageRepository:
          ImageIdentifier: !Ref AppImageUri
          ImageRepositoryType: ECR
          ImageConfiguration:
            Port: 8080
            RuntimeEnvironmentVariables:
              - Name: PORT
                Value: 8080
      InstanceConfiguration:
        Cpu: 1 vCPU
        Memory: 3 GB
        InstanceRoleArn: !GetAtt WebApplicationInstanceRole.Arn
      Tags: 
        - Key: Name
          Value: wind-farm-app-service

  WebACLAssociation:
    Type: AWS::WAFv2::WebACLAssociation
    Properties:
      WebACLArn: !GetAtt WebApplicationWebACL.Arn
      ResourceArn: !GetAtt WebApplication.ServiceArn

Outputs:
  GatewayUrl:
    Description: "Bedrock AgentCore Gateway URL"
    Value: !GetAtt WindAgentCoreGateway.GatewayUrl
  RuntimeArn:
    Description: "AgentCore Runtime Arn"
    Value: !GetAtt Runtime.AgentRuntimeArn
  WebAppUrl:
    Description: "Web Application URL"
    Value: !GetAtt WebApplication.ServiceUrl
